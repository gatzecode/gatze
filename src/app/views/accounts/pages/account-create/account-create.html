<div class="w-full min-h-screen p-4 sm:p-6 lg:p-8">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-4xl font-bold text-text tracking-tight flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-primary/10 dark:bg-primary/20 flex items-center justify-center shadow-professional">
            <mat-icon class="text-primary">add_business</mat-icon>
          </div>
          Crear Nueva Cuenta de Crédito
        </h1>
        <p class="mt-2 text-base text-secondary font-normal">
          <span class="cursor-pointer hover:text-primary transition-colors" (click)="onCancel()">Cuentas de Crédito</span>
          <span> / </span>
          <span>Nueva Cuenta</span>
        </p>
      </div>
      <div class="flex gap-3">
        <button mat-button (click)="onCancel()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Wizard Card -->
  <mat-card>
    <mat-stepper orientation="horizontal" linear #stepper (selectionChange)="onStepChange($event)">
      <!-- Step 1: Account Information -->
      <mat-step [stepControl]="accountForm" label="Información de Cuenta">
        <div class="p-6">
          <div class="flex items-center gap-2 mb-6 pb-3 border-b-2 border-primary">
            <mat-icon class="text-primary">account_balance_wallet</mat-icon>
            <h3 class="text-lg font-semibold text-text">Datos de la Cuenta</h3>
          </div>

          <form [formGroup]="accountForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-text mb-1">Número de Cuenta</label>
              <mat-form-field appearance="outline" class="w-full">
                <input
                  matInput
                  formControlName="accountNumber"
                  placeholder="10 dígitos"
                  maxlength="10">
                <mat-icon matPrefix>account_balance</mat-icon>
                <mat-hint>Identificador único de la cuenta</mat-hint>
                @if (accountForm.get('accountNumber')?.invalid && accountForm.get('accountNumber')?.touched) {
                  <mat-error>{{ getErrorMessage(accountForm, 'accountNumber') }}</mat-error>
                }
              </mat-form-field>
            </div>

            <div>
              <label class="block text-sm font-medium text-text mb-1">Tipo de Cuenta</label>
              <mat-form-field appearance="outline" class="w-full">
                <mat-select formControlName="accountType">
                  <mat-option value="CREDIT">Crédito</mat-option>
                  <mat-option value="DEBIT">Débito</mat-option>
                </mat-select>
                <mat-icon matPrefix>category</mat-icon>
              </mat-form-field>
            </div>

            <div>
              <label class="block text-sm font-medium text-text mb-1">Límite de Crédito</label>
              <mat-form-field appearance="outline" class="w-full">
                <input
                  matInput
                  type="number"
                  formControlName="creditLimit"
                  placeholder="50000">
                <span matPrefix>$&nbsp;</span>
                <span matSuffix>MXN</span>
                @if (accountForm.get('creditLimit')?.invalid && accountForm.get('creditLimit')?.touched) {
                  <mat-error>{{ getErrorMessage(accountForm, 'creditLimit') }}</mat-error>
                }
              </mat-form-field>
            </div>
          </form>

          <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button mat-button (click)="onCancel()">
              <mat-icon>close</mat-icon>
              Cancelar
            </button>
            <button mat-button color="primary" matStepperNext [disabled]="accountForm.invalid">
              Siguiente
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 2: Cardholder Information -->
      <mat-step [stepControl]="cardholderForm" label="Tarjetahabiente">
        <div class="p-6">
          <div class="flex items-center gap-2 mb-6 pb-3 border-b-2 border-primary">
            <mat-icon class="text-primary">person</mat-icon>
            <h3 class="text-lg font-semibold text-text">Información del Tarjetahabiente</h3>
          </div>

          <form [formGroup]="cardholderForm" class="space-y-6">
            <!-- Personal Information -->
            <div>
              <h4 class="text-sm font-semibold text-secondary mb-4">Datos Personales</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-text mb-1">Nombre(s)</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="firstName" required>
                    <mat-icon matPrefix>badge</mat-icon>
                    @if (cardholderForm.get('firstName')?.invalid && cardholderForm.get('firstName')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'firstName') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Apellido Paterno</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="lastName" required>
                    <mat-icon matPrefix>badge</mat-icon>
                    @if (cardholderForm.get('lastName')?.invalid && cardholderForm.get('lastName')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'lastName') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Apellido Materno</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="secondLastName">
                    <mat-icon matPrefix>badge</mat-icon>
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Fecha de Nacimiento</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput [matDatepicker]="birthPicker" formControlName="birthDate" required>
                    <mat-icon matPrefix>cake</mat-icon>
                    <mat-datepicker-toggle matSuffix [for]="birthPicker"></mat-datepicker-toggle>
                    <mat-datepicker #birthPicker></mat-datepicker>
                    @if (cardholderForm.get('birthDate')?.invalid && cardholderForm.get('birthDate')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'birthDate') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">RFC</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="rfc" required maxlength="13" class="uppercase" (input)="toUpperCase($event, 'rfc')">
                    <mat-icon matPrefix>assignment_ind</mat-icon>
                    @if (cardholderForm.get('rfc')?.invalid && cardholderForm.get('rfc')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'rfc') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">CURP</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="curp" required maxlength="18" class="uppercase" (input)="toUpperCase($event, 'curp')">
                    <mat-icon matPrefix>fingerprint</mat-icon>
                    @if (cardholderForm.get('curp')?.invalid && cardholderForm.get('curp')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'curp') }}</mat-error>
                    }
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div>
              <h4 class="text-sm font-semibold text-secondary mb-4">Contacto</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-text mb-1">Teléfono Celular</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="cellPhone" required maxlength="10">
                    <mat-icon matPrefix>smartphone</mat-icon>
                    @if (cardholderForm.get('cellPhone')?.invalid && cardholderForm.get('cellPhone')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'cellPhone') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Correo Electrónico</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="email" required type="email">
                    <mat-icon matPrefix>email</mat-icon>
                    @if (cardholderForm.get('email')?.invalid && cardholderForm.get('email')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'email') }}</mat-error>
                    }
                  </mat-form-field>
                </div>
              </div>
            </div>

            <!-- Address/Tax Information -->
            <div>
              <h4 class="text-sm font-semibold text-secondary mb-4">Domicilio Fiscal</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-3">
                  <label class="block text-sm font-medium text-text mb-1">Calle</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="street" required>
                    <mat-icon matPrefix>signpost</mat-icon>
                    @if (cardholderForm.get('street')?.invalid && cardholderForm.get('street')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'street') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Número Exterior</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="exteriorNumber" required>
                    <mat-icon matPrefix>tag</mat-icon>
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Número Interior</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="interiorNumber">
                    <mat-icon matPrefix>meeting_room</mat-icon>
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Código Postal</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="zipCode" required maxlength="5">
                    <mat-icon matPrefix>markunread_mailbox</mat-icon>
                    @if (cardholderForm.get('zipCode')?.invalid && cardholderForm.get('zipCode')?.touched) {
                      <mat-error>{{ getErrorMessage(cardholderForm, 'zipCode') }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Colonia</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="neighborhood" required>
                    <mat-icon matPrefix>location_city</mat-icon>
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Municipio/Alcaldía</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput formControlName="municipality" required>
                    <mat-icon matPrefix>apartment</mat-icon>
                  </mat-form-field>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-1">Estado</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-select formControlName="state" required>
                      @for (state of states; track state) {
                        <mat-option [value]="state">{{ state }}</mat-option>
                      }
                    </mat-select>
                    <mat-icon matPrefix>map</mat-icon>
                  </mat-form-field>
                </div>

                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-text mb-1">Régimen Fiscal</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-select formControlName="taxRegime" required>
                      @for (regime of taxRegimes; track regime.value) {
                        <mat-option [value]="regime.value">{{ regime.label }}</mat-option>
                      }
                    </mat-select>
                    <mat-icon matPrefix>account_balance</mat-icon>
                  </mat-form-field>
                </div>

                <div class="md:col-span-3">
                  <label class="block text-sm font-medium text-text mb-1">Uso de CFDI</label>
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-select formControlName="cfdiUse" required>
                      @for (use of cfdiUses; track use.value) {
                        <mat-option [value]="use.value">{{ use.label }}</mat-option>
                      }
                    </mat-select>
                    <mat-icon matPrefix>receipt</mat-icon>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </form>

          <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <button mat-button color="primary" matStepperNext [disabled]="cardholderForm.invalid">
              Siguiente
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 3: Card Information -->
      <mat-step [stepControl]="cardForm" label="Tarjeta Principal">
        <div class="p-6">
          <div class="flex items-center gap-2 mb-6 pb-3 border-b-2 border-primary">
            <mat-icon class="text-primary">credit_card</mat-icon>
            <h3 class="text-lg font-semibold text-text">Tarjeta Principal</h3>
          </div>

          <form [formGroup]="cardForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text mb-1">Número de Tarjeta</label>
                <mat-form-field appearance="outline" class="w-full">
                  <input matInput formControlName="cardNumber" required maxlength="16">
                  <mat-icon matPrefix>credit_card</mat-icon>
                  <mat-hint>16 dígitos</mat-hint>
                  @if (cardForm.get('cardNumber')?.invalid && cardForm.get('cardNumber')?.touched) {
                    <mat-error>{{ getErrorMessage(cardForm, 'cardNumber') }}</mat-error>
                  }
                </mat-form-field>
              </div>

              <div>
                <label class="block text-sm font-medium text-text mb-1">Marca</label>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-select formControlName="manufacturer" required>
                    <mat-option value="VISA">VISA</mat-option>
                    <mat-option value="MASTERCARD">Mastercard</mat-option>
                    <mat-option value="AMERICAN EXPRESS">American Express</mat-option>
                  </mat-select>
                  <mat-icon matPrefix>payment</mat-icon>
                </mat-form-field>
              </div>

              <div>
                <label class="block text-sm font-medium text-text mb-1">Fecha de Expiración</label>
                <mat-form-field appearance="outline" class="w-full">
                  <input matInput [matDatepicker]="expirationPicker" formControlName="expiration" required>
                  <mat-icon matPrefix>event</mat-icon>
                  <mat-datepicker-toggle matSuffix [for]="expirationPicker"></mat-datepicker-toggle>
                  <mat-datepicker #expirationPicker></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text mb-1">Nombre en Tarjeta (Opcional)</label>
                <mat-form-field appearance="outline" class="w-full">
                  <input matInput formControlName="embossName" maxlength="26" class="uppercase">
                  <mat-icon matPrefix>text_fields</mat-icon>
                  <mat-hint>Máx 26 caracteres. Se generará automáticamente si se deja vacío</mat-hint>
                </mat-form-field>
              </div>
            </div>

            <div>
              <h4 class="text-sm font-semibold text-secondary mb-4">Métodos de Acceso</h4>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <mat-checkbox formControlName="accessPOS" color="primary">
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-sm">point_of_sale</mat-icon>
                    <span>POS (Punto de Venta)</span>
                  </div>
                </mat-checkbox>

                <mat-checkbox formControlName="accessATM" color="primary">
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-sm">local_atm</mat-icon>
                    <span>ATM (Cajero)</span>
                  </div>
                </mat-checkbox>

                <mat-checkbox formControlName="accessEcommerce" color="primary">
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-sm">shopping_cart</mat-icon>
                    <span>E-Commerce</span>
                  </div>
                </mat-checkbox>
              </div>
            </div>
          </form>

          <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <button mat-button color="primary" matStepperNext [disabled]="cardForm.invalid">
              Revisar
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 4: Summary -->
      <mat-step label="Confirmar">
        <div class="p-6">
          <div class="flex items-center gap-2 mb-6 pb-3 border-b-2 border-primary">
            <mat-icon class="text-primary">check_circle</mat-icon>
            <h3 class="text-lg font-semibold text-text">Resumen de la Cuenta</h3>
          </div>

          <div class="space-y-4">
            <!-- Account Summary -->
            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
              <h4 class="font-semibold text-primary mb-3">Cuenta</h4>
              <div class="space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Número de Cuenta:</span>
                  <span class="text-sm font-mono text-text">{{ accountForm.value.accountNumber }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Tipo:</span>
                  <span class="text-sm text-text">{{ accountForm.value.accountType }}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-sm font-medium text-secondary">Límite de Crédito:</span>
                  <span class="text-sm font-semibold text-text">${{ accountForm.value.creditLimit | number:'1.2-2' }} MXN</span>
                </div>
              </div>
            </div>

            <!-- Cardholder Summary -->
            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
              <h4 class="font-semibold text-primary mb-3">Tarjetahabiente</h4>
              <div class="space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Nombre Completo:</span>
                  <span class="text-sm text-text">
                    {{ cardholderForm.value.firstName }}
                    {{ cardholderForm.value.lastName }}
                    {{ cardholderForm.value.secondLastName }}
                  </span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">RFC:</span>
                  <span class="text-sm font-mono text-text">{{ cardholderForm.value.rfc }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">CURP:</span>
                  <span class="text-sm font-mono text-text">{{ cardholderForm.value.curp }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Email:</span>
                  <span class="text-sm text-text">{{ cardholderForm.value.email }}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-sm font-medium text-secondary">Teléfono:</span>
                  <span class="text-sm text-text">{{ cardholderForm.value.cellPhone }}</span>
                </div>
              </div>
            </div>

            <!-- Card Summary -->
            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
              <h4 class="font-semibold text-primary mb-3">Tarjeta Principal</h4>
              <div class="space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Número:</span>
                  <span class="text-sm font-mono text-text">{{ cardForm.value.cardNumber | maskCard }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                  <span class="text-sm font-medium text-secondary">Marca:</span>
                  <span class="text-sm text-text">{{ cardForm.value.manufacturer }}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-sm font-medium text-secondary">Métodos Activos:</span>
                  <span class="text-sm text-text">
                    <span class="inline-flex gap-2">
                      @if (cardForm.value.accessPOS) {
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">POS</span>
                      }
                      @if (cardForm.value.accessATM) {
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">ATM</span>
                      }
                      @if (cardForm.value.accessEcommerce) {
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">E-Commerce</span>
                      }
                    </span>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Anterior
            </button>
            <button
              mat-button
              color="primary"
              (click)="onCreate()"
              [disabled]="creating() || accountForm.invalid || cardholderForm.invalid || cardForm.invalid">
              @if (creating()) {
                <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
              } @else {
                <mat-icon>check</mat-icon>
              }
              Crear Cuenta
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  </mat-card>
</div>
